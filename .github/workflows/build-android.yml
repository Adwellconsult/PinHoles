name: Build Android APK

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    env:
      ANDROID_ACCEPT_LICENSES: true
      BUILDOZER_LOG_LEVEL: 2
      BUILDOZER_ACCEPT_LICENSE: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Set up Java 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install Android SDK components
      run: |
        set -euo pipefail
        # Accept ALL licenses first (including future ones that buildozer might request)
        yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses || true
        # Install our required components plus the build-tools version buildozer wants
        ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager "platforms;android-33" "ndk;25.2.9519653" "build-tools;33.0.2" "build-tools;36.1.0"
        # Accept licenses again after installation
        yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install buildozer 
        pip install --upgrade cython
        
    - name: Accept Buildozer license
      run: |
        # Create buildozer directory and accept license
        mkdir -p ~/.buildozer
        # Accept Buildozer license by creating acceptance file
        echo "I have read and agree to the Buildozer license terms" > ~/.buildozer/license_accepted
        # Also set environment variable for automatic acceptance
        export BUILDOZER_ACCEPT_LICENSE=1
        # Initialize buildozer to trigger license acceptance
        echo "y" | buildozer init || true
        
    - name: Cache Buildozer global directory
      uses: actions/cache@v3
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-
        
    - name: Cache Buildozer local directory
      uses: actions/cache@v3
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-local-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-local-
    
    - name: Prepare build environment
      run: |
        # Create necessary directories
        mkdir -p ~/.buildozer
        
        # Verify Android setup
        echo "Android Home: $ANDROID_HOME"
        echo "Android SDK Root: $ANDROID_SDK_ROOT"
        echo "Available NDK versions:"
        ls -la $ANDROID_HOME/ndk/ 2>/dev/null || echo "NDK directory not found"
        
        # Set NDK path (will be used by buildozer)
        if [ -d "$ANDROID_HOME/ndk/25.2.9519653" ]; then
          echo "NDK 25.2.9519653 found"
        fi
    
    - name: Build APK with Buildozer
      run: |
        # Create Buildozer's expected SDK directory structure
        mkdir -p ~/.buildozer/android/platform/android-sdk/tools/bin
        
        # Create symlinks to system Android SDK components
        ln -sf $ANDROID_HOME/build-tools ~/.buildozer/android/platform/android-sdk/build-tools
        ln -sf $ANDROID_HOME/platforms ~/.buildozer/android/platform/android-sdk/platforms
        ln -sf $ANDROID_HOME/platform-tools ~/.buildozer/android/platform/android-sdk/platform-tools
        ln -sf $ANDROID_HOME/cmdline-tools ~/.buildozer/android/platform/android-sdk/cmdline-tools
        ln -sf $ANDROID_HOME/ndk ~/.buildozer/android/platform/android-sdk/ndk
        
        # Create symlink for sdkmanager in the old tools/bin location
        ln -sf $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager ~/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager
        
        # Set Android environment variables for buildozer
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653
        export ANDROIDAPI="33"
        export NDKAPI="21"
        
        # Accept licenses one more time before buildozer runs
        yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses || true
        
        # Build the APK
        buildozer android debug
    
    - name: Get build info
      id: build_info
      run: |
        # Extract version from buildozer.spec
        VERSION=$(grep "version =" buildozer.spec | cut -d'=' -f2 | tr -d ' ')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        # Get commit SHA (short)
        COMMIT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
        
        # Set build timestamp
        BUILD_TIME=$(date +'%Y%m%d-%H%M%S')
        echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
        
        # Set APK filename
        APK_NAME="BulletDetector-$VERSION-$COMMIT_SHA.apk"
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
    
    - name: Rename and prepare APK
      run: |
        # Find the generated APK
        APK_PATH=$(find bin/ -name "*.apk" | head -1)
        echo "Found APK: $APK_PATH"
        
        # Create releases directory
        mkdir -p releases
        
        # Copy and rename APK
        cp "$APK_PATH" "releases/${{ steps.build_info.outputs.apk_name }}"
        
        # Create a latest symlink for convenience
        cd releases
        ln -sf "${{ steps.build_info.outputs.apk_name }}" "BulletDetector-latest.apk"
        ls -la
    
    - name: Generate build manifest
      run: |
        cat > releases/build-info.json << EOF
        {
          "version": "${{ steps.build_info.outputs.version }}",
          "commit_sha": "${{ steps.build_info.outputs.commit_sha }}",
          "build_time": "${{ steps.build_info.outputs.build_time }}",
          "apk_filename": "${{ steps.build_info.outputs.apk_name }}",
          "github_run_id": "${{ github.run_id }}",
          "github_ref": "${{ github.ref }}",
          "github_actor": "${{ github.actor }}"
        }
        EOF
    
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: bullet-detector-apk
        path: releases/
        retention-days: 90
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          releases/${{ steps.build_info.outputs.apk_name }}
          releases/build-info.json
        name: Release ${{ steps.build_info.outputs.version }}
        body: |
          ## Bullet Impact Detector v${{ steps.build_info.outputs.version }}
          
          ### ðŸŽ¯ Features
          - Target center selection with red crosshair cursor
          - Multiple scoring ring definition
          - Video file and camera input support
          - Real-time bullet impact detection
          - Professional scoring system
          - Mobile-optimized UI with aspect ratio preservation
          
          ### ðŸ“± Installation
          1. Download the APK file below
          2. Enable "Install from unknown sources" on your Android device
          3. Install the APK
          4. Grant camera permissions when prompted
          
          ### ðŸ”§ Build Information
          - **Version:** ${{ steps.build_info.outputs.version }}
          - **Commit:** ${{ steps.build_info.outputs.commit_sha }}
          - **Built:** ${{ steps.build_info.outputs.build_time }}
          - **Platform:** Android (ARM64/ARMv7)
          
          ### ðŸ“‹ System Requirements
          - Android 5.0+ (API 21+)
          - Camera permission
          - 100MB storage space
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Deploy to releases branch (on main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        # Configure git
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # Create or checkout releases branch
        git fetch origin
        if git show-ref --verify --quiet refs/remotes/origin/releases; then
          git checkout -b releases origin/releases
        else
          git checkout --orphan releases
          git rm -rf .
        fi
        
        # Copy build artifacts
        cp -r releases/* .
        
        # Create README for releases branch
        cat > README.md << EOF
        # Bullet Impact Detector - Releases
        
        This branch contains pre-built Android APK files for the Bullet Impact Detector app.
        
        ## Latest Release
        - **File:** [\`${{ steps.build_info.outputs.apk_name }}\`](${{ steps.build_info.outputs.apk_name }})
        - **Version:** ${{ steps.build_info.outputs.version }}
        - **Built:** ${{ steps.build_info.outputs.build_time }}
        - **Commit:** ${{ steps.build_info.outputs.commit_sha }}
        
        ## Installation Instructions
        
        ### Android Device
        1. Download the APK file
        2. Enable "Install from unknown sources" in Android settings
        3. Install the APK
        4. Grant camera permissions when prompted
        
        ### Features
        - ðŸŽ¯ Precise target center selection with red crosshair
        - ðŸŸ¢ Multiple scoring ring definition
        - ðŸ“¹ Video file and live camera support
        - ðŸ“Š Real-time bullet impact detection and scoring
        - ðŸ“± Mobile-optimized interface
        - ðŸ”„ Aspect ratio preservation
        - â¸ï¸ Video pause for accurate baseline setup 
        
        ## Build Information
        Generated automatically by GitHub Actions from the main branch.
        EOF
        
        # Add and commit files
        git add .
        git commit -m "Release build ${{ steps.build_info.outputs.version }} from ${{ steps.build_info.outputs.commit_sha }}"
        
        # Push to releases branch
        git push origin releases
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build summary
      run: |
        echo "## ðŸŽ¯ Build Complete! ðŸŽ¯" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.build_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ steps.build_info.outputs.commit_sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **APK File:** ${{ steps.build_info.outputs.apk_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Time:** ${{ steps.build_info.outputs.build_time }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“± Installation" >> $GITHUB_STEP_SUMMARY
        echo "1. Download APK from the artifacts or releases" >> $GITHUB_STEP_SUMMARY
        echo "2. Enable 'Install from unknown sources' on Android" >> $GITHUB_STEP_SUMMARY
        echo "3. Install and grant camera permissions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Access Points" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifacts:** Available in this workflow run" >> $GITHUB_STEP_SUMMARY
        echo "- **Releases Branch:** \`releases\` branch for latest builds" >> $GITHUB_STEP_SUMMARY
        echo "- **Tagged Releases:** GitHub Releases for stable versions" >> $GITHUB_STEP_SUMMARY